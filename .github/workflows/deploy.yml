name: CipherBank Backend - Blue/Green Deploy

on:
  push:
    branches: [ release ]  # â† CHANGED: From 'main' to 'release'
    paths:
      - 'src/**'
      - 'pom.xml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  APP_NAME: cipherbank
  BLUE_PORT: 8083
  GREEN_PORT: 8084
  HEALTH_ENDPOINT: /actuator/health
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  SSH_HOST: ${{ secrets.GCP_HOST }}
  SSH_USER: ${{ secrets.GCP_USER }}
  SSH_KEY: ${{ secrets.GCP_SSH_KEY }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # ==================== INITIALIZATION ====================
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ”§ Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ env.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸ“ Set Build Variables
        id: vars
        run: |
          echo "BUILD_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "COMMIT_MSG=$(git log -1 --pretty=%B | head -n1)" >> $GITHUB_OUTPUT
          echo "AUTHOR=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
      
      - name: ğŸ“¢ Notify Deployment Start
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="ğŸš€ <b>CipherBank Backend Deployment Started</b>
          
          ğŸ“Š <b>Build Info</b>
          â€¢ Commit: <code>${{ steps.vars.outputs.COMMIT_SHA }}</code>
          â€¢ Author: ${{ steps.vars.outputs.AUTHOR }}
          â€¢ Time: ${{ steps.vars.outputs.BUILD_TIME }}
          
          ğŸ’¬ <i>${{ steps.vars.outputs.COMMIT_MSG }}</i>
          
          â³ Building application..."
      
      # ==================== BUILD ====================
      - name: ğŸ—ï¸ Build with Maven
        id: build
        run: |
          echo "ğŸ”¨ Starting Maven build..."
          mvn clean package -DskipTests -B
          
          if [ $? -eq 0 ]; then
            JAR_FILE=$(find target -name "*.jar" ! -name "*sources.jar" ! -name "*javadoc.jar" | head -1)
            JAR_SIZE=$(du -h "$JAR_FILE" | cut -f1)
            echo "jar_file=$JAR_FILE" >> $GITHUB_OUTPUT
            echo "jar_size=$JAR_SIZE" >> $GITHUB_OUTPUT
            echo "âœ… Build successful: $JAR_FILE ($JAR_SIZE)"
          else
            echo "âŒ Build failed"
            exit 1
          fi
      
      - name: ğŸ“¢ Notify Build Complete
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="âœ… Build completed
          â€¢ Size: ${{ steps.build.outputs.jar_size }}
          â€¢ Uploading to server..."
      
      # ==================== DETECT ACTIVE COLOR ====================
      - name: ğŸ¨ Detect Active Color
        id: detect_color
        run: |
          ACTIVE_COLOR=$(ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
            "if systemctl is-active --quiet ${{ env.APP_NAME }}-blue; then echo 'blue'; else echo 'green'; fi")
          
          if [ "$ACTIVE_COLOR" = "blue" ]; then
            DEPLOY_COLOR="green"
            DEPLOY_PORT="${{ env.GREEN_PORT }}"
            ACTIVE_PORT="${{ env.BLUE_PORT }}"
          else
            DEPLOY_COLOR="blue"
            DEPLOY_PORT="${{ env.BLUE_PORT }}"
            ACTIVE_PORT="${{ env.GREEN_PORT }}"
          fi
          
          echo "active_color=$ACTIVE_COLOR" >> $GITHUB_OUTPUT
          echo "deploy_color=$DEPLOY_COLOR" >> $GITHUB_OUTPUT
          echo "deploy_port=$DEPLOY_PORT" >> $GITHUB_OUTPUT
          echo "active_port=$ACTIVE_PORT" >> $GITHUB_OUTPUT
          
          echo "ğŸ¯ Active: $ACTIVE_COLOR (port $ACTIVE_PORT)"
          echo "ğŸ¯ Deploying to: $DEPLOY_COLOR (port $DEPLOY_PORT)"
      
      # ==================== DEPLOY ====================
      - name: ğŸ“¤ Upload JAR to Server
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ steps.build.outputs.jar_file }} \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:/home/bugsandfeaturesco/${{ env.APP_NAME }}-${{ steps.detect_color.outputs.deploy_color }}/app.jar
      
      - name: ğŸ“¤ Upload Environment File
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            cat > /home/bugsandfeaturesco/${{ env.APP_NAME }}-${{ steps.detect_color.outputs.deploy_color }}/.env << 'EOF'
          SERVER_PORT=${{ steps.detect_color.outputs.deploy_port }}
          SPRING_PROFILES_ACTIVE=prod
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          IP_WHITELIST_ENABLED=true
          IP_WHITELIST_DEBUG=false
          EOF
          ENDSSH
      
      - name: ğŸ”„ Restart Service
        id: restart
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            set -e
            
            echo "ğŸ”„ Restarting ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.deploy_color }} service..."
            sudo systemctl restart ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.deploy_color }}
            
            echo "â³ Waiting for service to start..."
            sleep 5
            
            if sudo systemctl is-active --quiet ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.deploy_color }}; then
              echo "âœ… Service started successfully"
            else
              echo "âŒ Service failed to start"
              sudo journalctl -u ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.deploy_color }} -n 50 --no-pager
              exit 1
            fi
          ENDSSH
      
      # ==================== HEALTH CHECK ====================
      - name: ğŸ¥ Health Check
        id: health
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            set -e
            
            MAX_ATTEMPTS=30
            ATTEMPT=0
            HEALTH_URL="http://localhost:${{ steps.detect_color.outputs.deploy_port }}${{ env.HEALTH_ENDPOINT }}"
            
            echo "ğŸ¥ Starting health checks on $HEALTH_URL"
            
            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              ATTEMPT=$((ATTEMPT + 1))
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
              
              RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
              
              if [ "$RESPONSE" = "200" ]; then
                HEALTH_DATA=$(curl -s "$HEALTH_URL")
                echo "âœ… Health check passed!"
                echo "Response: $HEALTH_DATA"
                exit 0
              fi
              
              echo "â³ Service not ready yet (HTTP $RESPONSE), waiting 2s..."
              sleep 2
            done
            
            echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
            echo "ğŸ“‹ Last 50 logs:"
            sudo journalctl -u ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.deploy_color }} -n 50 --no-pager
            exit 1
          ENDSSH
      
      - name: ğŸ“¢ Notify Health Check Success
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="âœ… Health check passed
          â€¢ Color: ${{ steps.detect_color.outputs.deploy_color }}
          â€¢ Port: ${{ steps.detect_color.outputs.deploy_port }}
          â€¢ Switching traffic..."
      
      # ==================== TRAFFIC SWITCH ====================
      - name: ğŸ”€ Switch Traffic
        id: switch
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            set -e
            
            # Update nginx upstream configuration
            PROXY_CONF="/www/server/panel/vhost/nginx/proxy/${{ env.APP_NAME }}.conf"
            
            # Create backup
            sudo cp "$PROXY_CONF" "${PROXY_CONF}.backup"
            
            # Update port in proxy config
            sudo sed -i 's/proxy_pass http:\/\/127\.0\.0\.1:[0-9]\+/proxy_pass http:\/\/127.0.0.1:${{ steps.detect_color.outputs.deploy_port }}/g' "$PROXY_CONF"
            
            # Test nginx config
            if sudo nginx -t 2>&1; then
              echo "âœ… Nginx config valid"
              sudo nginx -s reload
              echo "âœ… Nginx reloaded"
            else
              echo "âŒ Nginx config invalid, restoring backup"
              sudo mv "${PROXY_CONF}.backup" "$PROXY_CONF"
              sudo nginx -s reload
              exit 1
            fi
          ENDSSH
      
      - name: ğŸ§ª Verify Traffic Switch
        run: |
          sleep 3
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://cipher.thepaytrix.com${{ env.HEALTH_ENDPOINT }} || echo "000")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… Traffic successfully switched to ${{ steps.detect_color.outputs.deploy_color }}"
          else
            echo "âŒ Traffic switch verification failed (HTTP $RESPONSE)"
            exit 1
          fi
      
      # ==================== CLEANUP OLD VERSION ====================
      - name: ğŸ§¹ Stop Old Version
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            echo "ğŸ›‘ Stopping ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.active_color }} service..."
            sudo systemctl stop ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.active_color }} || true
            echo "âœ… Old version stopped"
          ENDSSH
      
      # ==================== SUCCESS NOTIFICATION ====================
      - name: ğŸ“¢ Notify Deployment Success
        if: success()
        run: |
          DEPLOY_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC')
          
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="âœ… <b>CipherBank Backend Deployment Successful</b>
          
          ğŸ¯ <b>Deployment Details</b>
          â€¢ Color: ${{ steps.detect_color.outputs.active_color }} â†’ <b>${{ steps.detect_color.outputs.deploy_color }}</b>
          â€¢ Port: ${{ steps.detect_color.outputs.active_port }} â†’ <b>${{ steps.detect_color.outputs.deploy_port }}</b>
          â€¢ Size: ${{ steps.build.outputs.jar_size }}
          
          ğŸ“Š <b>Build Info</b>
          â€¢ Commit: <code>${{ steps.vars.outputs.COMMIT_SHA }}</code>
          â€¢ Author: ${{ steps.vars.outputs.AUTHOR }}
          â€¢ Built: ${{ steps.vars.outputs.BUILD_TIME }}
          â€¢ Deployed: $DEPLOY_TIME
          
          ğŸŒ <b>Endpoints</b>
          â€¢ API: https://cipher.thepaytrix.com/api
          â€¢ Health: https://cipher.thepaytrix.com${{ env.HEALTH_ENDPOINT }}
          
          ğŸ’¬ <i>${{ steps.vars.outputs.COMMIT_MSG }}</i>"
      
      # ==================== FAILURE HANDLING ====================
      - name: ğŸš¨ Rollback on Failure
        if: failure() && steps.switch.outcome == 'failure'
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            echo "ğŸš¨ Deployment failed, initiating rollback..."
            
            # Stop failed deployment
            sudo systemctl stop ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.deploy_color }} || true
            
            # Restore nginx config from backup if it exists
            PROXY_CONF="/www/server/panel/vhost/nginx/proxy/${{ env.APP_NAME }}.conf"
            if [ -f "${PROXY_CONF}.backup" ]; then
              sudo mv "${PROXY_CONF}.backup" "$PROXY_CONF"
              sudo nginx -s reload
              echo "âœ… Nginx config restored"
            fi
            
            # Ensure old version is running
            sudo systemctl start ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.active_color }}
            
            echo "âœ… Rollback complete, service restored to ${{ steps.detect_color.outputs.active_color }}"
          ENDSSH
      
      - name: ğŸ“¢ Notify Deployment Failure
        if: failure()
        run: |
          # Get error context
          FAILED_STEP="${{ job.status }}"
          ERROR_LOG=$(ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
            "sudo journalctl -u ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.deploy_color }} -n 20 --no-pager" || echo "Could not retrieve logs")
          
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="âŒ <b>CipherBank Backend Deployment Failed</b>
          
          ğŸš¨ <b>Failure Details</b>
          â€¢ Failed Step: ${{ steps.detect_color.outcome == 'failure' && 'Color Detection' || steps.build.outcome == 'failure' && 'Build' || steps.restart.outcome == 'failure' && 'Service Restart' || steps.health.outcome == 'failure' && 'Health Check' || steps.switch.outcome == 'failure' && 'Traffic Switch' || 'Unknown' }}
          â€¢ Target: ${{ steps.detect_color.outputs.deploy_color }} (port ${{ steps.detect_color.outputs.deploy_port }})
          
          ğŸ“Š <b>Build Info</b>
          â€¢ Commit: <code>${{ steps.vars.outputs.COMMIT_SHA }}</code>
          â€¢ Author: ${{ steps.vars.outputs.AUTHOR }}
          
          ğŸ”„ <b>Status</b>
          â€¢ Rollback: Initiated
          â€¢ Active: ${{ steps.detect_color.outputs.active_color }} (unchanged)
          
          ğŸ“‹ <b>Recent Logs</b>
          <code>${ERROR_LOG:0:500}</code>
          
          ğŸ”— <a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View Full Logs</a>"