name: CipherBank Backend - Blue/Green Deploy

on:
  push:
    branches: [ release ]
    paths:
      - 'src/**'
      - 'pom.xml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  APP_NAME: cipherbank
  BLUE_PORT: 8083
  GREEN_PORT: 8084
  HEALTH_ENDPOINT: /actuator/health
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  SSH_HOST: ${{ secrets.GCP_HOST }}
  SSH_USER: ${{ secrets.GCP_USER }}
  SSH_KEY: ${{ secrets.GCP_SSH_KEY }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # ==================== INITIALIZATION ====================
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîß Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: üîë Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ env.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts
      
      - name: üìù Set Build Variables
        id: vars
        run: |
          echo "BUILD_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "COMMIT_MSG=$(git log -1 --pretty=%B | head -n1)" >> $GITHUB_OUTPUT
          echo "AUTHOR=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
      
      - name: üì¢ Notify Deployment Start
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="üöÄ <b>CipherBank Backend Deployment Started</b>
          
          üìä <b>Build Info</b>
          ‚Ä¢ Commit: <code>${{ steps.vars.outputs.COMMIT_SHA }}</code>
          ‚Ä¢ Author: ${{ steps.vars.outputs.AUTHOR }}
          ‚Ä¢ Time: ${{ steps.vars.outputs.BUILD_TIME }}
          
          üí¨ <i>${{ steps.vars.outputs.COMMIT_MSG }}</i>
          
          ‚è≥ Building application..."
      
      # ==================== BUILD ====================
      - name: üèóÔ∏è Build with Maven
        id: build
        run: |
          echo "üî® Starting Maven build..."
          mvn clean package -DskipTests -B
          
          if [ $? -eq 0 ]; then
            JAR_FILE=$(find target -name "*.jar" ! -name "*sources.jar" ! -name "*javadoc.jar" | head -1)
            JAR_SIZE=$(du -h "$JAR_FILE" | cut -f1)
            echo "jar_file=$JAR_FILE" >> $GITHUB_OUTPUT
            echo "jar_size=$JAR_SIZE" >> $GITHUB_OUTPUT
            echo "‚úÖ Build successful: $JAR_FILE ($JAR_SIZE)"
          else
            echo "‚ùå Build failed"
            exit 1
          fi
      
      - name: üì¢ Notify Build Complete
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="‚úÖ Build completed
          ‚Ä¢ Size: ${{ steps.build.outputs.jar_size }}
          ‚Ä¢ Uploading to server..."
      
      # ==================== DETECT ACTIVE COLOR ====================
      - name: üé® Detect Active Color
        id: detect_color
        run: |
          ACTIVE_COLOR=$(ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
            "if systemctl is-active --quiet ${{ env.APP_NAME }}-blue; then echo 'blue'; else echo 'green'; fi")
          
          if [ "$ACTIVE_COLOR" = "blue" ]; then
            DEPLOY_COLOR="green"
            DEPLOY_PORT="${{ env.GREEN_PORT }}"
            ACTIVE_PORT="${{ env.BLUE_PORT }}"
          else
            DEPLOY_COLOR="blue"
            DEPLOY_PORT="${{ env.BLUE_PORT }}"
            ACTIVE_PORT="${{ env.GREEN_PORT }}"
          fi
          
          echo "active_color=$ACTIVE_COLOR" >> $GITHUB_OUTPUT
          echo "deploy_color=$DEPLOY_COLOR" >> $GITHUB_OUTPUT
          echo "deploy_port=$DEPLOY_PORT" >> $GITHUB_OUTPUT
          echo "active_port=$ACTIVE_PORT" >> $GITHUB_OUTPUT
          
          echo "Active: $ACTIVE_COLOR (port $ACTIVE_PORT)"
          echo "Deploying to: $DEPLOY_COLOR (port $DEPLOY_PORT)"
      
      # ==================== DEPLOY ====================
      - name: üì§ Upload JAR to Server
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ steps.build.outputs.jar_file }} \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:/home/${{ env.SSH_USER }}/${{ env.APP_NAME }}-${{ steps.detect_color.outputs.deploy_color }}/app.jar
          
          echo "‚úÖ JAR uploaded successfully"
      
      - name: üîÑ Restart Service
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            echo "üîÑ Restarting ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.deploy_color }} service..."
            sudo systemctl restart ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.deploy_color }}
            
            echo "‚è≥ Waiting for service to start..."
            sleep 5
            
            if sudo systemctl is-active --quiet ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.deploy_color }}; then
              echo "‚úÖ Service started successfully"
            else
              echo "‚ùå Service failed to start"
              sudo journalctl -u ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.deploy_color }} -n 50 --no-pager
              exit 1
            fi
          ENDSSH
      
      # ==================== HEALTH CHECK ====================
      - name: üè• Health Check
        id: health
        run: |
          # Run health check and capture exit code explicitly
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} bash << 'ENDSSH'
          
          MAX_ATTEMPTS=30
          ATTEMPT=0
          HEALTH_URL="http://localhost:${{ steps.detect_color.outputs.deploy_port }}${{ env.HEALTH_ENDPOINT }}"
          
          echo "üè• Starting health checks on $HEALTH_URL"
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" 2>/dev/null || echo "000")
            
            if [ "$RESPONSE" = "200" ]; then
              HEALTH_DATA=$(curl -s "$HEALTH_URL")
              echo "‚úÖ Health check passed!"
              echo "Response: $HEALTH_DATA"
              exit 0
            fi
            
            echo "‚è≥ Service not ready yet (HTTP $RESPONSE), waiting 2s..."
            sleep 2
          done
          
          echo "‚ùå Health check failed after $MAX_ATTEMPTS attempts"
          echo "üìã Last 50 logs:"
          sudo journalctl -u ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.deploy_color }} -n 50 --no-pager
          exit 1
          ENDSSH
          
          # Check the exit code from SSH
          if [ $? -ne 0 ]; then
            echo "Health check failed"
            exit 1
          fi
      
      - name: üì¢ Notify Health Check Success
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="‚úÖ Health check passed
          ‚Ä¢ Color: ${{ steps.detect_color.outputs.deploy_color }}
          ‚Ä¢ Port: ${{ steps.detect_color.outputs.deploy_port }}
          ‚Ä¢ Switching traffic..."
      
      # ==================== TRAFFIC SWITCH ====================
      - name: üîÄ Switch Traffic
        id: switch
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} bash << 'ENDSSH'
          
          PROXY_CONF="/www/server/panel/vhost/nginx/proxy/${{ env.APP_NAME }}.conf"
          
          echo "üìù Updating nginx configuration..."
          
          # Create backup
          sudo cp "$PROXY_CONF" "${PROXY_CONF}.backup"
          
          # Update port in proxy config using the actual pattern that exists
          sudo sed -i 's|proxy_pass http://127\.0\.0\.1:[0-9]\{4\}|proxy_pass http://127.0.0.1:${{ steps.detect_color.outputs.deploy_port }}|g' "$PROXY_CONF"
          
          # Verify the change was made
          if sudo grep -q "proxy_pass http://127.0.0.1:${{ steps.detect_color.outputs.deploy_port }}" "$PROXY_CONF"; then
            echo "‚úÖ Port updated to ${{ steps.detect_color.outputs.deploy_port }}"
          else
            echo "‚ùå Failed to update port in config"
            sudo cat "$PROXY_CONF"
            exit 1
          fi
          
          # Test nginx config
          if sudo nginx -t 2>&1; then
            echo "‚úÖ Nginx config valid"
            sudo nginx -s reload
            echo "‚úÖ Nginx reloaded"
            exit 0
          else
            echo "‚ùå Nginx config invalid, restoring backup"
            sudo mv "${PROXY_CONF}.backup" "$PROXY_CONF"
            sudo nginx -s reload
            exit 1
          fi
          ENDSSH
          
          # Check the exit code from SSH
          if [ $? -ne 0 ]; then
            echo "Traffic switch failed"
            exit 1
          fi
      
      - name: üß™ Verify Traffic Switch
        run: |
          sleep 3
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://cipher.thepaytrix.com${{ env.HEALTH_ENDPOINT }} || echo "000")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Traffic successfully switched to ${{ steps.detect_color.outputs.deploy_color }}"
          else
            echo "‚ùå Traffic switch verification failed (HTTP $RESPONSE)"
            exit 1
          fi
      
      # ==================== CLEANUP OLD VERSION ====================
      - name: üßπ Stop Old Version
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            echo "üõë Stopping ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.active_color }} service..."
            sudo systemctl stop ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.active_color }} || true
            echo "‚úÖ Old version stopped"
          ENDSSH
      
      # ==================== SUCCESS NOTIFICATION ====================
      - name: üì¢ Notify Deployment Success
        if: success()
        run: |
          DEPLOY_TIME=$(date +'%Y-%m-%d %H:%M:%S UTC')
          
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="‚úÖ <b>CipherBank Backend Deployment Successful</b>
          
          üéØ <b>Deployment Details</b>
          ‚Ä¢ Color: ${{ steps.detect_color.outputs.active_color }} ‚Üí <b>${{ steps.detect_color.outputs.deploy_color }}</b>
          ‚Ä¢ Port: ${{ steps.detect_color.outputs.active_port }} ‚Üí <b>${{ steps.detect_color.outputs.deploy_port }}</b>
          ‚Ä¢ Size: ${{ steps.build.outputs.jar_size }}
          
          üìä <b>Build Info</b>
          ‚Ä¢ Commit: <code>${{ steps.vars.outputs.COMMIT_SHA }}</code>
          ‚Ä¢ Author: ${{ steps.vars.outputs.AUTHOR }}
          ‚Ä¢ Built: ${{ steps.vars.outputs.BUILD_TIME }}
          ‚Ä¢ Deployed: $DEPLOY_TIME
          
          üåê <b>Endpoints</b>
          ‚Ä¢ API: https://cipher.thepaytrix.com/api
          ‚Ä¢ Health: https://cipher.thepaytrix.com${{ env.HEALTH_ENDPOINT }}
          
          üí¨ <i>${{ steps.vars.outputs.COMMIT_MSG }}</i>"
      
      # ==================== FAILURE HANDLING ====================
      - name: üö® Rollback on Failure
        if: failure() && steps.switch.outcome == 'failure'
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'ENDSSH'
            echo "üö® Deployment failed, initiating rollback..."
            
            # Stop failed deployment
            sudo systemctl stop ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.deploy_color }} || true
            
            # Restore nginx config from backup if it exists
            PROXY_CONF="/www/server/panel/vhost/nginx/proxy/${{ env.APP_NAME }}.conf"
            if [ -f "${PROXY_CONF}.backup" ]; then
              sudo mv "${PROXY_CONF}.backup" "$PROXY_CONF"
              sudo nginx -s reload
              echo "‚úÖ Nginx config restored"
            fi
            
            # Ensure old version is running
            sudo systemctl start ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.active_color }}
            
            echo "‚úÖ Rollback complete, service restored to ${{ steps.detect_color.outputs.active_color }}"
          ENDSSH
      
      - name: üì¢ Notify Deployment Failure
        if: failure()
        run: |
          # Get error context
          FAILED_STEP="${{ job.status }}"
          ERROR_LOG=$(ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} \
            "sudo journalctl -u ${{ env.APP_NAME }}-${{ steps.detect_color.outputs.deploy_color }} -n 20 --no-pager" || echo "Could not retrieve logs")
          
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d text="‚ùå <b>CipherBank Backend Deployment Failed</b>
          
          üö® <b>Failure Details</b>
          ‚Ä¢ Failed Step: ${{ steps.detect_color.outcome == 'failure' && 'Color Detection' || steps.build.outcome == 'failure' && 'Build' || steps.restart.outcome == 'failure' && 'Service Restart' || steps.health.outcome == 'failure' && 'Health Check' || steps.switch.outcome == 'failure' && 'Traffic Switch' || 'Unknown' }}
          ‚Ä¢ Target: ${{ steps.detect_color.outputs.deploy_color }} (port ${{ steps.detect_color.outputs.deploy_port }})
          
          üìä <b>Build Info</b>
          ‚Ä¢ Commit:  <code>${{ steps.vars.outputs.COMMIT_SHA }}</code>
          ‚Ä¢ Author: ${{ steps.vars.outputs.AUTHOR }}
          
          üîÑ <b>Status</b>
          ‚Ä¢ Rollback: Initiated
          ‚Ä¢ Active: ${{ steps.detect_color.outputs.active_color }} (unchanged)
          
          üìã <b>Recent Logs</b>
          <code>${ERROR_LOG:0:500}</code>
          
          üîó <a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View Full Logs</a>"
